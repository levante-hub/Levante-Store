name: Validate MCPs

on:
  pull_request:
    paths:
      - 'src/data/mcps/**/*.json'
  push:
    branches:
      - main
    paths:
      - 'src/data/mcps/**/*.json'

jobs:
  validate-schema:
    name: Validate MCP Schema
    runs-on: ubuntu-latest
    outputs:
      testable-mcps: ${{ steps.find-testable.outputs.mcps }}
      http-mcps: ${{ steps.find-http.outputs.mcps }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate all MCPs
        run: npm run validate-mcps

      - name: List MCPs
        run: npm run list-mcps

      - name: Check for duplicate IDs
        run: |
          echo "Checking for duplicate MCP IDs..."
          DUPLICATES=$(node scripts/list-mcps.mjs --json | jq -r '.[].id' | sort | uniq -d)
          if [ -n "$DUPLICATES" ]; then
            echo "Error: Duplicate MCP IDs found:"
            echo "$DUPLICATES"
            exit 1
          fi
          echo "No duplicate IDs found"

      - name: Find testable STDIO MCPs
        id: find-testable
        run: |
          MCPS=$(node scripts/list-mcps.mjs --json | jq -c '[.[] | select(.transport == "stdio")]')
          echo "mcps=$MCPS" >> $GITHUB_OUTPUT

      - name: Find testable HTTP MCPs
        id: find-http
        run: |
          MCPS=$(node scripts/list-mcps.mjs --json | jq -c '[.[] | select(.transport == "sse" or .transport == "streamable-http")]')
          echo "mcps=$MCPS" >> $GITHUB_OUTPUT

  test-stdio-mcps:
    name: Test STDIO MCPs
    runs-on: ubuntu-latest
    needs: validate-schema
    if: needs.validate-schema.outputs.testable-mcps != '[]'
    strategy:
      fail-fast: false
      matrix:
        mcp: ${{ fromJson(needs.validate-schema.outputs.testable-mcps) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Setup Python and uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: false

      - name: Setup pipx
        run: |
          python -m pip install --user pipx
          python -m pipx ensurepath
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Test ${{ matrix.mcp.name }} with MCP Inspector
        continue-on-error: true
        timeout-minutes: 3
        run: |
          echo "Testing MCP: ${{ matrix.mcp.name }} (${{ matrix.mcp.id }})"
          MCP_FILE=$(find src/data/mcps -name "*.json" -exec grep -l '"id": "${{ matrix.mcp.id }}"' {} \; | head -1)
          if [ -n "$MCP_FILE" ]; then
            COMMAND=$(jq -r '.configuration.template.command' "$MCP_FILE")
            ARGS=$(jq -r '.configuration.template.args | join(" ")' "$MCP_FILE")

            echo "Running: npx @modelcontextprotocol/inspector@latest --cli $COMMAND $ARGS --method tools/list"
            npx @modelcontextprotocol/inspector@latest --cli $COMMAND $ARGS --method tools/list || echo "MCP test completed (may require auth)"
          fi

  test-http-mcps:
    name: Test HTTP MCPs
    runs-on: ubuntu-latest
    needs: validate-schema
    if: needs.validate-schema.outputs.http-mcps != '[]'
    strategy:
      fail-fast: false
      matrix:
        mcp: ${{ fromJson(needs.validate-schema.outputs.http-mcps) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Test ${{ matrix.mcp.name }} endpoint
        continue-on-error: true
        timeout-minutes: 2
        run: |
          echo "Testing MCP: ${{ matrix.mcp.name }} (${{ matrix.mcp.id }})"
          MCP_FILE=$(find src/data/mcps -name "*.json" -exec grep -l '"id": "${{ matrix.mcp.id }}"' {} \; | head -1)
          if [ -n "$MCP_FILE" ]; then
            TRANSPORT=$(jq -r '.transport' "$MCP_FILE")
            URL=$(jq -r '.configuration.template.url' "$MCP_FILE")

            # Remove template variables from URL for basic connectivity test
            CLEAN_URL=$(echo "$URL" | sed 's/\${[^}]*}//g' | sed 's/[?&][^?&]*=$//' | sed 's/[?&]$//')

            echo "Transport: $TRANSPORT"
            echo "URL: $CLEAN_URL"

            # Map transport to inspector flag
            if [ "$TRANSPORT" = "sse" ]; then
              TRANSPORT_FLAG="sse"
            else
              TRANSPORT_FLAG="http"
            fi

            echo "Running: npx @modelcontextprotocol/inspector@latest --transport $TRANSPORT_FLAG --server-url $CLEAN_URL --cli --method tools/list"

            # Test connection - 401/403 is valid (MCP exists but requires auth)
            RESULT=$(npx @modelcontextprotocol/inspector@latest --transport $TRANSPORT_FLAG --server-url "$CLEAN_URL" --cli --method tools/list 2>&1) || true

            echo "$RESULT"

            if echo "$RESULT" | grep -qE "(tools|401|403|Unauthorized|Forbidden)"; then
              echo "✓ MCP endpoint is reachable"
            else
              echo "⚠ MCP endpoint test inconclusive"
            fi
          fi
