name: Validate MCPs

on:
  pull_request:
    paths:
      - 'src/data/mcps/**/*.json'
  push:
    branches:
      - main
    paths:
      - 'src/data/mcps/**/*.json'

jobs:
  validate-schema:
    name: Validate MCP Schema
    runs-on: ubuntu-latest
    outputs:
      testable-mcps: ${{ steps.find-testable.outputs.mcps }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate all MCPs
        run: npm run validate-mcps

      - name: List MCPs
        run: npm run list-mcps

      - name: Check for duplicate IDs
        run: |
          echo "Checking for duplicate MCP IDs..."
          DUPLICATES=$(node scripts/list-mcps.mjs --json | jq -r '.[].id' | sort | uniq -d)
          if [ -n "$DUPLICATES" ]; then
            echo "Error: Duplicate MCP IDs found:"
            echo "$DUPLICATES"
            exit 1
          fi
          echo "No duplicate IDs found"

      - name: Find testable MCPs (stdio without required inputs)
        id: find-testable
        run: |
          MCPS=$(node scripts/list-mcps.mjs --json | jq -c '[.[] | select(.transport == "stdio")]')
          echo "mcps=$MCPS" >> $GITHUB_OUTPUT

  test-stdio-mcps:
    name: Test STDIO MCPs
    runs-on: ubuntu-latest
    needs: validate-schema
    if: needs.validate-schema.outputs.testable-mcps != '[]'
    strategy:
      fail-fast: false
      matrix:
        mcp: ${{ fromJson(needs.validate-schema.outputs.testable-mcps) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Pre-install MCP Inspector
        run: npm install -g @modelcontextprotocol/inspector@latest

      - name: Test ${{ matrix.mcp.name }} with MCP Inspector
        continue-on-error: true
        timeout-minutes: 3
        run: |
          echo "Testing MCP: ${{ matrix.mcp.name }} (${{ matrix.mcp.id }})"
          # Read MCP config and extract command
          MCP_FILE=$(find src/data/mcps -name "*.json" -exec grep -l '"id": "${{ matrix.mcp.id }}"' {} \; | head -1)
          if [ -n "$MCP_FILE" ]; then
            COMMAND=$(jq -r '.configuration.template.command' "$MCP_FILE")
            ARGS=$(jq -r '.configuration.template.args | join(" ")' "$MCP_FILE")
            echo "Running: mcp-inspector --cli $COMMAND $ARGS --method tools/list"
            # Retry up to 3 times with increasing delay
            for i in 1 2 3; do
              mcp-inspector --cli $COMMAND $ARGS --method tools/list --timeout 60000 && break
              echo "Attempt $i failed, retrying in ${i}0 seconds..."
              sleep $((i * 10))
            done || echo "MCP test completed (may require auth or network issues)"
          fi
